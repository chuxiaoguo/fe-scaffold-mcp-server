name: ğŸ“Š ä»£ç è¦†ç›–ç‡æŠ¥å‘Š

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**/*.ts'
      - 'tests/**/*'
  pull_request:
    branches: [main]
    paths:
      - 'src/**/*.ts'  
      - 'tests/**/*'
  workflow_dispatch:

jobs:
  coverage:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        node-version: [18, 20]

    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: æ„å»ºé¡¹ç›®
        run: npm run build

      - name: è¿è¡Œè¦†ç›–ç‡æµ‹è¯•
        run: npm run test:coverage

      - name: ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Šæ‘˜è¦
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            echo "ğŸ“Š ä»£ç è¦†ç›–ç‡æŠ¥å‘Šæ‘˜è¦" > coverage-summary.md
            echo "========================" >> coverage-summary.md
            echo "" >> coverage-summary.md
            
            # æå–è¦†ç›–ç‡æ•°æ®
            lines_pct=$(node -p "require('./coverage/coverage-summary.json').total.lines.pct")
            functions_pct=$(node -p "require('./coverage/coverage-summary.json').total.functions.pct")
            branches_pct=$(node -p "require('./coverage/coverage-summary.json').total.branches.pct")
            statements_pct=$(node -p "require('./coverage/coverage-summary.json').total.statements.pct")
            
            echo "| æŒ‡æ ‡ | è¦†ç›–ç‡ | çŠ¶æ€ |" >> coverage-summary.md
            echo "|------|--------|------|" >> coverage-summary.md
            echo "| è¡Œè¦†ç›–ç‡ | ${lines_pct}% | $([ $lines_pct -ge 80 ] && echo 'âœ… è‰¯å¥½' || echo 'âš ï¸ éœ€æ”¹è¿›') |" >> coverage-summary.md
            echo "| å‡½æ•°è¦†ç›–ç‡ | ${functions_pct}% | $([ $functions_pct -ge 80 ] && echo 'âœ… è‰¯å¥½' || echo 'âš ï¸ éœ€æ”¹è¿›') |" >> coverage-summary.md
            echo "| åˆ†æ”¯è¦†ç›–ç‡ | ${branches_pct}% | $([ $branches_pct -ge 70 ] && echo 'âœ… è‰¯å¥½' || echo 'âš ï¸ éœ€æ”¹è¿›') |" >> coverage-summary.md
            echo "| è¯­å¥è¦†ç›–ç‡ | ${statements_pct}% | $([ $statements_pct -ge 80 ] && echo 'âœ… è‰¯å¥½' || echo 'âš ï¸ éœ€æ”¹è¿›') |" >> coverage-summary.md
            echo "" >> coverage-summary.md
            echo "**æŠ¥å‘Šæ—¶é—´:** $(date)" >> coverage-summary.md
            echo "**å¹³å°:** ${{ matrix.os }}" >> coverage-summary.md
            echo "**Node.jsç‰ˆæœ¬:** ${{ matrix.node-version }}" >> coverage-summary.md
            
            # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
            echo "LINES_COVERAGE=$lines_pct" >> $GITHUB_ENV
            echo "FUNCTIONS_COVERAGE=$functions_pct" >> $GITHUB_ENV
            echo "BRANCHES_COVERAGE=$branches_pct" >> $GITHUB_ENV
            echo "STATEMENTS_COVERAGE=$statements_pct" >> $GITHUB_ENV
          fi

      - name: æ£€æŸ¥è¦†ç›–ç‡é˜ˆå€¼
        run: |
          # è®¾ç½®è¦†ç›–ç‡é˜ˆå€¼
          MIN_LINES_COVERAGE=75
          MIN_FUNCTIONS_COVERAGE=75
          MIN_BRANCHES_COVERAGE=65
          MIN_STATEMENTS_COVERAGE=75
          
          echo "ğŸ¯ æ£€æŸ¥è¦†ç›–ç‡é˜ˆå€¼..."
          echo "  æœ€ä½è¡Œè¦†ç›–ç‡è¦æ±‚: ${MIN_LINES_COVERAGE}%"
          echo "  æœ€ä½å‡½æ•°è¦†ç›–ç‡è¦æ±‚: ${MIN_FUNCTIONS_COVERAGE}%"
          echo "  æœ€ä½åˆ†æ”¯è¦†ç›–ç‡è¦æ±‚: ${MIN_BRANCHES_COVERAGE}%"
          echo "  æœ€ä½è¯­å¥è¦†ç›–ç‡è¦æ±‚: ${MIN_STATEMENTS_COVERAGE}%"
          echo ""
          
          # æ£€æŸ¥æ˜¯å¦æ»¡è¶³é˜ˆå€¼
          THRESHOLD_FAILED=false
          
          if [ "${LINES_COVERAGE%.*}" -lt "$MIN_LINES_COVERAGE" ]; then
            echo "âŒ è¡Œè¦†ç›–ç‡ ${LINES_COVERAGE}% ä½äºæœ€ä½è¦æ±‚ ${MIN_LINES_COVERAGE}%"
            THRESHOLD_FAILED=true
          else
            echo "âœ… è¡Œè¦†ç›–ç‡ ${LINES_COVERAGE}% æ»¡è¶³è¦æ±‚"
          fi
          
          if [ "${FUNCTIONS_COVERAGE%.*}" -lt "$MIN_FUNCTIONS_COVERAGE" ]; then
            echo "âŒ å‡½æ•°è¦†ç›–ç‡ ${FUNCTIONS_COVERAGE}% ä½äºæœ€ä½è¦æ±‚ ${MIN_FUNCTIONS_COVERAGE}%"
            THRESHOLD_FAILED=true
          else
            echo "âœ… å‡½æ•°è¦†ç›–ç‡ ${FUNCTIONS_COVERAGE}% æ»¡è¶³è¦æ±‚"
          fi
          
          if [ "${BRANCHES_COVERAGE%.*}" -lt "$MIN_BRANCHES_COVERAGE" ]; then
            echo "âŒ åˆ†æ”¯è¦†ç›–ç‡ ${BRANCHES_COVERAGE}% ä½äºæœ€ä½è¦æ±‚ ${MIN_BRANCHES_COVERAGE}%"
            THRESHOLD_FAILED=true
          else
            echo "âœ… åˆ†æ”¯è¦†ç›–ç‡ ${BRANCHES_COVERAGE}% æ»¡è¶³è¦æ±‚"
          fi
          
          if [ "${STATEMENTS_COVERAGE%.*}" -lt "$MIN_STATEMENTS_COVERAGE" ]; then
            echo "âŒ è¯­å¥è¦†ç›–ç‡ ${STATEMENTS_COVERAGE}% ä½äºæœ€ä½è¦æ±‚ ${MIN_STATEMENTS_COVERAGE}%"
            THRESHOLD_FAILED=true
          else
            echo "âœ… è¯­å¥è¦†ç›–ç‡ ${STATEMENTS_COVERAGE}% æ»¡è¶³è¦æ±‚"
          fi
          
          if [ "$THRESHOLD_FAILED" = true ]; then
            echo ""
            echo "âš ï¸ éƒ¨åˆ†è¦†ç›–ç‡æŒ‡æ ‡æœªè¾¾åˆ°æœ€ä½è¦æ±‚ï¼Œè¯·å¢åŠ æµ‹è¯•ç”¨ä¾‹"
            exit 1
          else
            echo ""
            echo "ğŸ‰ æ‰€æœ‰è¦†ç›–ç‡æŒ‡æ ‡éƒ½è¾¾åˆ°è¦æ±‚ï¼"
          fi

      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Šåˆ°Codecov
        uses: codecov/codecov-action@v3
        if: matrix.os == 'ubuntu-latest' && matrix.node-version == '20'
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-${{ matrix.os }}-node${{ matrix.node-version }}
          fail_ci_if_error: false

      - name: ç”Ÿæˆè¦†ç›–ç‡å¾½ç« æ•°æ®
        if: matrix.os == 'ubuntu-latest' && matrix.node-version == '20'
        run: |
          # ç”Ÿæˆå¾½ç« æ•°æ®
          if [ -f coverage/coverage-summary.json ]; then
            lines_pct=$(node -p "require('./coverage/coverage-summary.json').total.lines.pct")
            
            # ç¡®å®šå¾½ç« é¢œè‰²
            if [ "${lines_pct%.*}" -ge 80 ]; then
              badge_color="brightgreen"
            elif [ "${lines_pct%.*}" -ge 70 ]; then
              badge_color="yellow"
            else
              badge_color="red"
            fi
            
            # ç”Ÿæˆshields.ioæ ¼å¼çš„JSON
            cat > coverage-badge.json << EOF
            {
              "schemaVersion": 1,
              "label": "coverage",
              "message": "${lines_pct}%",
              "color": "${badge_color}"
            }
            EOF
            
            echo "ğŸ“› ç”Ÿæˆè¦†ç›–ç‡å¾½ç« æ•°æ®: ${lines_pct}% (${badge_color})"
          fi

      - name: åˆ†æè¦†ç›–ç‡å˜åŒ–è¶‹åŠ¿
        if: matrix.os == 'ubuntu-latest' && matrix.node-version == '20'
        run: |
          # å¦‚æœå­˜åœ¨ä¹‹å‰çš„è¦†ç›–ç‡æ•°æ®ï¼Œè¿›è¡Œå¯¹æ¯”
          if [ -f previous-coverage.json ] && [ -f coverage/coverage-summary.json ]; then
            echo "ğŸ“ˆ åˆ†æè¦†ç›–ç‡å˜åŒ–è¶‹åŠ¿..."
            
            prev_lines=$(node -p "require('./previous-coverage.json').total.lines.pct")
            curr_lines=$(node -p "require('./coverage/coverage-summary.json').total.lines.pct")
            
            # è®¡ç®—å˜åŒ–
            change=$(node -p "(${curr_lines} - ${prev_lines}).toFixed(2)")
            
            if [ "${change%.*}" -gt 0 ]; then
              echo "âœ… è¦†ç›–ç‡æå‡äº† ${change}%"
            elif [ "${change%.*}" -lt 0 ]; then
              echo "âš ï¸ è¦†ç›–ç‡ä¸‹é™äº† ${change}%"
            else
              echo "ğŸ“Š è¦†ç›–ç‡ä¿æŒä¸å˜"
            fi
            
            echo "COVERAGE_CHANGE=${change}" >> $GITHUB_ENV
          else
            echo "â„¹ï¸ æ— å†å²è¦†ç›–ç‡æ•°æ®è¿›è¡Œå¯¹æ¯”"
          fi

      - name: ç”Ÿæˆè¯¦ç»†çš„è¦†ç›–ç‡åˆ†ææŠ¥å‘Š
        if: matrix.os == 'ubuntu-latest' && matrix.node-version == '20'
        run: |
          if [ -f coverage/lcov.info ]; then
            echo "ğŸ“‹ ç”Ÿæˆè¯¦ç»†è¦†ç›–ç‡åˆ†ææŠ¥å‘Š..."
            
            # åˆ›å»ºè¯¦ç»†æŠ¥å‘Š
            cat > detailed-coverage-report.md << 'EOF'
            # ğŸ“Š è¯¦ç»†ä»£ç è¦†ç›–ç‡æŠ¥å‘Š
            
            ## ğŸ“ˆ æ€»ä½“ç»Ÿè®¡
            EOF
            
            # æ·»åŠ æ€»ä½“ç»Ÿè®¡
            if [ -f coverage/coverage-summary.json ]; then
              echo "" >> detailed-coverage-report.md
              echo "| ç±»å‹ | è¦†ç›–æ•°/æ€»æ•° | ç™¾åˆ†æ¯” |" >> detailed-coverage-report.md
              echo "|------|-------------|--------|" >> detailed-coverage-report.md
              
              # æå–è¯¦ç»†æ•°æ®
              lines_covered=$(node -p "require('./coverage/coverage-summary.json').total.lines.covered")
              lines_total=$(node -p "require('./coverage/coverage-summary.json').total.lines.total")
              lines_pct=$(node -p "require('./coverage/coverage-summary.json').total.lines.pct")
              
              functions_covered=$(node -p "require('./coverage/coverage-summary.json').total.functions.covered")
              functions_total=$(node -p "require('./coverage/coverage-summary.json').total.functions.total")
              functions_pct=$(node -p "require('./coverage/coverage-summary.json').total.functions.pct")
              
              branches_covered=$(node -p "require('./coverage/coverage-summary.json').total.branches.covered")
              branches_total=$(node -p "require('./coverage/coverage-summary.json').total.branches.total")
              branches_pct=$(node -p "require('./coverage/coverage-summary.json').total.branches.pct")
              
              statements_covered=$(node -p "require('./coverage/coverage-summary.json').total.statements.covered")
              statements_total=$(node -p "require('./coverage/coverage-summary.json').total.statements.total")
              statements_pct=$(node -p "require('./coverage/coverage-summary.json').total.statements.pct")
              
              echo "| è¡Œ | $lines_covered/$lines_total | $lines_pct% |" >> detailed-coverage-report.md
              echo "| å‡½æ•° | $functions_covered/$functions_total | $functions_pct% |" >> detailed-coverage-report.md
              echo "| åˆ†æ”¯ | $branches_covered/$branches_total | $branches_pct% |" >> detailed-coverage-report.md
              echo "| è¯­å¥ | $statements_covered/$statements_total | $statements_pct% |" >> detailed-coverage-report.md
            fi
            
            # æ·»åŠ æ–‡ä»¶çº§åˆ«çš„è¦†ç›–ç‡åˆ†æï¼ˆä»…æ˜¾ç¤ºè¦†ç›–ç‡è¾ƒä½çš„æ–‡ä»¶ï¼‰
            echo "" >> detailed-coverage-report.md
            echo "## ğŸ” éœ€è¦å…³æ³¨çš„æ–‡ä»¶ï¼ˆè¦†ç›–ç‡ < 80%ï¼‰" >> detailed-coverage-report.md
            echo "" >> detailed-coverage-report.md
            
            # è¿™é‡Œå¯ä»¥è¿›ä¸€æ­¥åˆ†ælcov.infoæ–‡ä»¶ï¼Œæå–æ–‡ä»¶çº§åˆ«çš„è¦†ç›–ç‡ä¿¡æ¯
            # ç®€åŒ–ç‰ˆæœ¬ï¼šåªæ˜¾ç¤ºæç¤ºä¿¡æ¯
            echo "è¯·æŸ¥çœ‹ç”Ÿæˆçš„HTMLæŠ¥å‘Šè·å–è¯¦ç»†çš„æ–‡ä»¶çº§åˆ«è¦†ç›–ç‡ä¿¡æ¯ã€‚" >> detailed-coverage-report.md
            echo "" >> detailed-coverage-report.md
            echo "## ğŸ’¡ æ”¹è¿›å»ºè®®" >> detailed-coverage-report.md
            echo "- ä¸ºè¦†ç›–ç‡è¾ƒä½çš„å‡½æ•°æ·»åŠ å•å…ƒæµ‹è¯•" >> detailed-coverage-report.md
            echo "- å¢åŠ è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸æƒ…å†µçš„æµ‹è¯•ç”¨ä¾‹" >> detailed-coverage-report.md
            echo "- å®šæœŸå®¡æŸ¥å’Œæ›´æ–°æµ‹è¯•ç”¨ä¾‹" >> detailed-coverage-report.md
            echo "" >> detailed-coverage-report.md
            echo "---" >> detailed-coverage-report.md
            echo "*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date)*" >> detailed-coverage-report.md
          fi

      - name: ä¸Šä¼ è¦†ç›–ç‡å·¥ä»¶
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-${{ matrix.os }}-node${{ matrix.node-version }}
          path: |
            coverage/
            coverage-summary.md
            coverage-badge.json
            detailed-coverage-report.md
          retention-days: 30

      - name: è¯„è®ºPRè¦†ç›–ç‡æŠ¥å‘Š (ä»…PR)
        if: github.event_name == 'pull_request' && matrix.os == 'ubuntu-latest' && matrix.node-version == '20'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            if (fs.existsSync('coverage-summary.md')) {
              const coverageReport = fs.readFileSync('coverage-summary.md', 'utf8');
              
              const comment = `## ğŸ“Š ä»£ç è¦†ç›–ç‡æŠ¥å‘Š
              
              ${coverageReport}
              
              <details>
              <summary>ğŸ” æŸ¥çœ‹è¦†ç›–ç‡è¯¦æƒ…</summary>
              
              - ğŸ“ å®Œæ•´çš„HTMLæŠ¥å‘Šè¯·æŸ¥çœ‹Actions artifacts
              - ğŸ¯ è¦†ç›–ç‡é˜ˆå€¼ï¼šè¡Œâ‰¥75%, å‡½æ•°â‰¥75%, åˆ†æ”¯â‰¥65%, è¯­å¥â‰¥75%
              - ğŸ“ˆ [æŸ¥çœ‹å†å²è¦†ç›–ç‡è¶‹åŠ¿](https://codecov.io/gh/${{ github.repository }})
              
              </details>
              
              ---
              *æ­¤æŠ¥å‘Šç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ ğŸ¤–*`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  # æ±‡æ€»è¦†ç›–ç‡æŠ¥å‘Š
  coverage-summary:
    runs-on: ubuntu-latest
    needs: coverage
    if: always()
    steps:
      - name: ä¸‹è½½æ‰€æœ‰è¦†ç›–ç‡æŠ¥å‘Š
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-report-*
          merge-multiple: true
          path: all-coverage-reports/

      - name: ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
        run: |
          echo "# ğŸ“Š è¦†ç›–ç‡æµ‹è¯•æ±‡æ€»æŠ¥å‘Š" > coverage-summary-report.md
          echo "" >> coverage-summary-report.md
          echo "**æµ‹è¯•æ—¶é—´:** $(date)" >> coverage-summary-report.md
          echo "**æµ‹è¯•åˆ†æ”¯:** ${{ github.ref_name }}" >> coverage-summary-report.md
          echo "" >> coverage-summary-report.md
          
          # ç»Ÿè®¡æµ‹è¯•ç»“æœ
          total_jobs=${{ strategy.job-total }}
          success_jobs=0
          
          echo "## ğŸ“‹ æµ‹è¯•ç¯å¢ƒç»“æœ" >> coverage-summary-report.md
          echo "| æ“ä½œç³»ç»Ÿ | Node.jsç‰ˆæœ¬ | çŠ¶æ€ |" >> coverage-summary-report.md
          echo "|----------|-------------|------|" >> coverage-summary-report.md
          
          # è¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„jobç»“æœæ¥å¡«å……è¡¨æ ¼
          # ç®€åŒ–ç‰ˆæœ¬
          echo "| Ubuntu | 18 | ${{ needs.coverage.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> coverage-summary-report.md
          echo "| Ubuntu | 20 | ${{ needs.coverage.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> coverage-summary-report.md
          echo "| Windows | 18 | ${{ needs.coverage.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> coverage-summary-report.md
          echo "| Windows | 20 | ${{ needs.coverage.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> coverage-summary-report.md
          echo "" >> coverage-summary-report.md
          
          if [ "${{ needs.coverage.result }}" == "success" ]; then
            echo "ğŸ‰ æ‰€æœ‰ç¯å¢ƒçš„è¦†ç›–ç‡æµ‹è¯•éƒ½å·²é€šè¿‡ï¼" >> coverage-summary-report.md
          else
            echo "âš ï¸ éƒ¨åˆ†ç¯å¢ƒçš„æµ‹è¯•å‡ºç°é—®é¢˜ï¼Œè¯·æ£€æŸ¥è¯¦ç»†æ—¥å¿—ã€‚" >> coverage-summary-report.md
          fi

      - name: ä¸Šä¼ æ±‡æ€»æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: coverage-summary-report
          path: coverage-summary-report.md