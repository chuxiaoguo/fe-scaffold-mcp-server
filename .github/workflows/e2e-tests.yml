name: ğŸ§ª ç”Ÿæˆé¡¹ç›®E2Eæµ‹è¯•

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'templates/**'
  pull_request:
    branches: [main]
  schedule:
    # æ¯å¤©æ—©ä¸Š8ç‚¹è¿è¡Œ
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      test-specific-template:
        description: 'æŒ‡å®šæµ‹è¯•æ¨¡æ¿ (ç•™ç©ºæµ‹è¯•å…¨éƒ¨)'
        required: false
        type: string

jobs:
  # ç”Ÿæˆé¡¹ç›®å¹¶è¿›è¡ŒE2Eæµ‹è¯•
  e2e-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        framework: [vue3, vue2, react]
        buildTool: [vite, webpack]
        language: [typescript, javascript]
        exclude:
          # æ’é™¤ä¸æ”¯æŒçš„ç»„åˆ
          - framework: vue2
            buildTool: vite
          - framework: react
            buildTool: webpack
            language: javascript
          # Windowsä¸Šåªæµ‹è¯•éƒ¨åˆ†ç»„åˆä»¥èŠ‚çœæ—¶é—´
          - os: windows-latest
            framework: vue2
          - os: windows-latest
            language: javascript
          # macOSä¸Šåªæµ‹è¯•ä¸»è¦ç»„åˆ
          - os: macos-latest
            framework: vue2
          - os: macos-latest
            buildTool: webpack

    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£…é¡¹ç›®ä¾èµ–
        run: npm ci

      - name: æ„å»ºè„šæ‰‹æ¶å·¥å…·
        run: npm run build

      - name: å…¨å±€å®‰è£…è„šæ‰‹æ¶å·¥å…·
        run: npm link

      - name: åˆ›å»ºæµ‹è¯•ç›®å½•
        run: |
          mkdir -p ${{ runner.temp }}/e2e-tests
          echo "TEST_DIR=${{ runner.temp }}/e2e-tests" >> $GITHUB_ENV

      - name: è·³è¿‡ç‰¹å®šæ¨¡æ¿æµ‹è¯•
        if: inputs.test-specific-template != '' && !contains(format('{0}-{1}', matrix.framework, matrix.buildTool), inputs.test-specific-template)
        run: |
          echo "è·³è¿‡æ¨¡æ¿: ${{ matrix.framework }}-${{ matrix.buildTool }}"
          exit 0

      - name: ç”Ÿæˆæµ‹è¯•é¡¹ç›®
        id: generate
        run: |
          cd ${{ env.TEST_DIR }}
          project_name="test-${{ matrix.framework }}-${{ matrix.buildTool }}-${{ matrix.language }}"
          echo "project_name=$project_name" >> $GITHUB_OUTPUT
          
          echo "ğŸš€ ç”Ÿæˆé¡¹ç›®: $project_name"
          fe-scaffold-mcp-server create-scaffold \
            --projectName="$project_name" \
            --framework=${{ matrix.framework }} \
            --buildTool=${{ matrix.buildTool }} \
            --language=${{ matrix.language }} \
            --styleFramework=tailwind \
            --features=eslint,prettier,testing,mock

      - name: éªŒè¯é¡¹ç›®ç»“æ„
        run: |
          cd ${{ env.TEST_DIR }}/${{ steps.generate.outputs.project_name }}
          
          echo "ğŸ“ éªŒè¯é¡¹ç›®ç»“æ„..."
          
          # æ£€æŸ¥å¿…è¦æ–‡ä»¶
          test -f package.json || (echo "âŒ package.jsonä¸å­˜åœ¨" && exit 1)
          test -f README.md || (echo "âŒ README.mdä¸å­˜åœ¨" && exit 1)
          
          # æ£€æŸ¥æºç ç›®å½•
          test -d src || (echo "âŒ srcç›®å½•ä¸å­˜åœ¨" && exit 1)
          
          # æ ¹æ®æ„å»ºå·¥å…·æ£€æŸ¥é…ç½®æ–‡ä»¶
          if [[ "${{ matrix.buildTool }}" == "vite" ]]; then
            test -f vite.config.* || (echo "âŒ viteé…ç½®æ–‡ä»¶ä¸å­˜åœ¨" && exit 1)
          elif [[ "${{ matrix.buildTool }}" == "webpack" ]]; then
            test -f webpack.config.* || (echo "âŒ webpacké…ç½®æ–‡ä»¶ä¸å­˜åœ¨" && exit 1)
          fi
          
          # æ£€æŸ¥TypeScripté…ç½®
          if [[ "${{ matrix.language }}" == "typescript" ]]; then
            test -f tsconfig.json || (echo "âŒ tsconfig.jsonä¸å­˜åœ¨" && exit 1)
          fi
          
          echo "âœ… é¡¹ç›®ç»“æ„éªŒè¯é€šè¿‡"

      - name: å®‰è£…ç”Ÿæˆé¡¹ç›®çš„ä¾èµ–
        run: |
          cd ${{ env.TEST_DIR }}/${{ steps.generate.outputs.project_name }}
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          npm install

      - name: è¿è¡Œç±»å‹æ£€æŸ¥ (TypeScript)
        if: matrix.language == 'typescript'
        run: |
          cd ${{ env.TEST_DIR }}/${{ steps.generate.outputs.project_name }}
          echo "ğŸ” TypeScriptç±»å‹æ£€æŸ¥..."
          if npm run type-check 2>/dev/null || npx tsc --noEmit 2>/dev/null; then
            echo "âœ… ç±»å‹æ£€æŸ¥é€šè¿‡"
          else
            echo "âš ï¸ ç±»å‹æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æµ‹è¯•"
          fi

      - name: è¿è¡Œä»£ç æ£€æŸ¥
        run: |
          cd ${{ env.TEST_DIR }}/${{ steps.generate.outputs.project_name }}
          echo "ğŸ” ä»£ç æ£€æŸ¥..."
          if npm run lint 2>/dev/null; then
            echo "âœ… ä»£ç æ£€æŸ¥é€šè¿‡"
          else
            echo "âš ï¸ ä»£ç æ£€æŸ¥æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æµ‹è¯•"
          fi

      - name: æ„å»ºé¡¹ç›®
        run: |
          cd ${{ env.TEST_DIR }}/${{ steps.generate.outputs.project_name }}
          echo "ğŸ—ï¸ æ„å»ºé¡¹ç›®..."
          npm run build

      - name: éªŒè¯æ„å»ºäº§ç‰©
        run: |
          cd ${{ env.TEST_DIR }}/${{ steps.generate.outputs.project_name }}
          
          # æ£€æŸ¥æ„å»ºè¾“å‡ºç›®å½•
          if [[ "${{ matrix.buildTool }}" == "vite" ]]; then
            test -d dist || (echo "âŒ distç›®å½•ä¸å­˜åœ¨" && exit 1)
            test -f dist/index.html || (echo "âŒ index.htmlä¸å­˜åœ¨" && exit 1)
          elif [[ "${{ matrix.buildTool }}" == "webpack" ]]; then
            test -d dist || test -d build || (echo "âŒ æ„å»ºè¾“å‡ºç›®å½•ä¸å­˜åœ¨" && exit 1)
          fi
          
          echo "âœ… æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡"

      - name: è¿è¡Œå•å…ƒæµ‹è¯• (å¦‚æœå­˜åœ¨)
        run: |
          cd ${{ env.TEST_DIR }}/${{ steps.generate.outputs.project_name }}
          echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
          if npm run test 2>/dev/null || npm run test:unit 2>/dev/null; then
            echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"
          else
            echo "â„¹ï¸ æœªé…ç½®å•å…ƒæµ‹è¯•æˆ–æµ‹è¯•å¤±è´¥"
          fi

      - name: æµ‹è¯•å¼€å‘æœåŠ¡å™¨å¯åŠ¨
        timeout-minutes: 3
        run: |
          cd ${{ env.TEST_DIR }}/${{ steps.generate.outputs.project_name }}
          echo "ğŸ–¥ï¸ æµ‹è¯•å¼€å‘æœåŠ¡å™¨..."
          
          # å¯åŠ¨å¼€å‘æœåŠ¡å™¨
          npm run dev &
          DEV_PID=$!
          
          # ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
          sleep 30
          
          # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿˜åœ¨è¿è¡Œ
          if kill -0 $DEV_PID 2>/dev/null; then
            echo "âœ… å¼€å‘æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ"
            kill $DEV_PID
          else
            echo "âŒ å¼€å‘æœåŠ¡å™¨å¯åŠ¨å¤±è´¥"
            exit 1
          fi

      - name: æ€§èƒ½åŸºå‡†æµ‹è¯•
        run: |
          cd ${{ env.TEST_DIR }}/${{ steps.generate.outputs.project_name }}
          echo "âš¡ æ€§èƒ½åŸºå‡†æµ‹è¯•..."
          
          # æµ‹è¯•æ„å»ºæ—¶é—´
          start_time=$(date +%s)
          npm run build
          end_time=$(date +%s)
          build_time=$((end_time - start_time))
          
          echo "ğŸ“Š æ„å»ºæ—¶é—´: ${build_time}ç§’"
          
          # æ£€æŸ¥bundleå¤§å° (å¦‚æœæ˜¯viteé¡¹ç›®)
          if [[ "${{ matrix.buildTool }}" == "vite" ]] && [ -d dist ]; then
            bundle_size=$(du -sh dist | cut -f1)
            echo "ğŸ“¦ Bundleå¤§å°: $bundle_size"
          fi

      - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        if: always()
        run: |
          cd ${{ env.TEST_DIR }}
          
          cat > test-report-${{ matrix.os }}-${{ matrix.framework }}-${{ matrix.buildTool }}-${{ matrix.language }}.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platform": "${{ matrix.os }}",
            "framework": "${{ matrix.framework }}",
            "buildTool": "${{ matrix.buildTool }}",
            "language": "${{ matrix.language }}",
            "projectName": "${{ steps.generate.outputs.project_name }}",
            "status": "${{ job.status }}",
            "nodeVersion": "$(node --version)",
            "npmVersion": "$(npm --version)"
          }
          EOF

      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-report-${{ matrix.os }}-${{ matrix.framework }}-${{ matrix.buildTool }}-${{ matrix.language }}
          path: |
            ${{ env.TEST_DIR }}/test-report-*.json
            ${{ env.TEST_DIR }}/${{ steps.generate.outputs.project_name }}/dist/
          retention-days: 7

      - name: æ¸…ç†æµ‹è¯•é¡¹ç›®
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†æµ‹è¯•æ–‡ä»¶..."
          rm -rf ${{ env.TEST_DIR }}

  # æ±‡æ€»æµ‹è¯•ç»“æœ
  test-summary:
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: always()
    steps:
      - name: ä¸‹è½½æ‰€æœ‰æµ‹è¯•æŠ¥å‘Š
        uses: actions/download-artifact@v4
        with:
          pattern: e2e-test-report-*
          merge-multiple: true
          path: test-reports/

      - name: ç”Ÿæˆæµ‹è¯•æ€»ç»“
        run: |
          echo "# ğŸ§ª E2Eæµ‹è¯•æ€»ç»“æŠ¥å‘Š" > test-summary.md
          echo "" >> test-summary.md
          echo "**æµ‹è¯•æ—¶é—´:** $(date)" >> test-summary.md
          echo "**æµ‹è¯•åˆ†æ”¯:** ${{ github.ref_name }}" >> test-summary.md
          echo "" >> test-summary.md
          
          # ç»Ÿè®¡æµ‹è¯•ç»“æœ
          total_tests=0
          passed_tests=0
          
          for report in test-reports/*.json; do
            if [ -f "$report" ]; then
              ((total_tests++))
              status=$(cat "$report" | jq -r '.status // "unknown"')
              if [ "$status" == "success" ]; then
                ((passed_tests++))
              fi
            fi
          done
          
          echo "## ğŸ“Š æµ‹è¯•ç»Ÿè®¡" >> test-summary.md
          echo "- æ€»æµ‹è¯•æ•°: $total_tests" >> test-summary.md
          echo "- é€šè¿‡æµ‹è¯•: $passed_tests" >> test-summary.md
          echo "- å¤±è´¥æµ‹è¯•: $((total_tests - passed_tests))" >> test-summary.md
          echo "- æˆåŠŸç‡: $(( passed_tests * 100 / total_tests ))%" >> test-summary.md
          echo "" >> test-summary.md
          
          # è¯¦ç»†æµ‹è¯•ç»“æœ
          echo "## ğŸ“‹ è¯¦ç»†ç»“æœ" >> test-summary.md
          echo "| å¹³å° | æ¡†æ¶ | æ„å»ºå·¥å…· | è¯­è¨€ | çŠ¶æ€ |" >> test-summary.md
          echo "|------|------|----------|------|------|" >> test-summary.md
          
          for report in test-reports/*.json; do
            if [ -f "$report" ]; then
              platform=$(cat "$report" | jq -r '.platform')
              framework=$(cat "$report" | jq -r '.framework')
              buildTool=$(cat "$report" | jq -r '.buildTool')
              language=$(cat "$report" | jq -r '.language')
              status=$(cat "$report" | jq -r '.status // "unknown"')
              
              if [ "$status" == "success" ]; then
                status_icon="âœ…"
              else
                status_icon="âŒ"
              fi
              
              echo "| $platform | $framework | $buildTool | $language | $status_icon $status |" >> test-summary.md
            fi
          done
          
          echo "" >> test-summary.md
          echo "---" >> test-summary.md
          echo "*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date)*" >> test-summary.md

      - name: ä¸Šä¼ æµ‹è¯•æ€»ç»“
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-summary
          path: test-summary.md

      - name: æ£€æŸ¥æµ‹è¯•æ˜¯å¦å…¨éƒ¨é€šè¿‡
        run: |
          # å¦‚æœæœ‰ä»»ä½•æµ‹è¯•å¤±è´¥ï¼Œæ ‡è®°workflowå¤±è´¥
          if [ ${{ needs.e2e-tests.result }} != "success" ]; then
            echo "âŒ E2Eæµ‹è¯•æœªå…¨éƒ¨é€šè¿‡"
            exit 1
          else
            echo "âœ… æ‰€æœ‰E2Eæµ‹è¯•é€šè¿‡"
          fi