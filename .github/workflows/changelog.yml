name: üìù Ëá™Âä®ÁîüÊàêChangelog

on:
  workflow_run:
    workflows: ["üöÄ Ëá™Âä®ÂåñÂèëÂ∏ÉÊµÅÁ®ã"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      version-range:
        description: 'ÁâàÊú¨ËåÉÂõ¥ (ÁïôÁ©∫‰∏∫Ëá™Âä®Ê£ÄÊµã)'
        required: false
        type: string
      update-readme:
        description: 'ÂêåÊó∂Êõ¥Êñ∞READMEÂæΩÁ´†'
        required: false
        default: true
        type: boolean

jobs:
  generate-changelog:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout‰ª£Á†Å
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ËÆæÁΩÆNode.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ÂÆâË£ÖchangelogÁîüÊàêÂ∑•ÂÖ∑
        run: |
          npm install -g conventional-changelog-cli auto-changelog

      - name: Ëé∑ÂèñÁâàÊú¨‰ø°ÊÅØ
        id: version-info
        run: |
          current_version=$(node -p "require('./package.json').version")
          echo "current_version=$current_version" >> $GITHUB_OUTPUT
          
          # Ëé∑ÂèñÊâÄÊúâÊ†áÁ≠æ
          git fetch --tags
          
          # Ëé∑Âèñ‰∏ä‰∏Ä‰∏™ÁâàÊú¨Ê†áÁ≠æ
          previous_tag=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          echo "previous_tag=$previous_tag" >> $GITHUB_OUTPUT
          
          # Á°ÆÂÆöÁâàÊú¨ËåÉÂõ¥
          if [[ -n "${{ inputs.version-range }}" ]]; then
            version_range="${{ inputs.version-range }}"
          elif [[ -n "$previous_tag" ]]; then
            version_range="$previous_tag..HEAD"
          else
            version_range="HEAD"
          fi
          echo "version_range=$version_range" >> $GITHUB_OUTPUT
          
          echo "üìã ÁâàÊú¨‰ø°ÊÅØ:"
          echo "  ÂΩìÂâçÁâàÊú¨: $current_version"
          echo "  ‰∏ä‰∏ÄÁâàÊú¨: $previous_tag"
          echo "  ÁâàÊú¨ËåÉÂõ¥: $version_range"

      - name: ÁîüÊàêÊèê‰∫§ÂàÜÁ±ª
        id: categorize-commits
        run: |
          # ÂàõÂª∫‰∏¥Êó∂Êñá‰ª∂Â≠òÂÇ®ÂàÜÁ±ªÂêéÁöÑÊèê‰∫§
          mkdir -p temp
          
          # Ëé∑ÂèñÊèê‰∫§ÂàóË°®
          if [[ "${{ steps.version-info.outputs.version_range }}" == "HEAD" ]]; then
            commits=$(git log --oneline --pretty=format:"%h|%s|%an|%ad" --date=short)
          else
            commits=$(git log --oneline --pretty=format:"%h|%s|%an|%ad" --date=short ${{ steps.version-info.outputs.version_range }})
          fi
          
          # ÂàÜÁ±ªÊèê‰∫§
          echo "$commits" | while IFS='|' read -r hash subject author date; do
            # Ë∑≥ËøáÂèëÂ∏ÉÊèê‰∫§
            if [[ "$subject" == *"chore: release"* ]] || [[ "$subject" == *"chore(release)"* ]]; then
              continue
            fi
            
            # ÂàÜÁ±ªÊèê‰∫§Á±ªÂûã
            if [[ "$subject" =~ ^feat(\(.+\))?!?: ]]; then
              echo "$hash|$subject|$author|$date" >> temp/features.txt
            elif [[ "$subject" =~ ^fix(\(.+\))?: ]]; then
              echo "$hash|$subject|$author|$date" >> temp/fixes.txt
            elif [[ "$subject" =~ ^perf(\(.+\))?: ]]; then
              echo "$hash|$subject|$author|$date" >> temp/performance.txt
            elif [[ "$subject" =~ ^docs(\(.+\))?: ]]; then
              echo "$hash|$subject|$author|$date" >> temp/docs.txt
            elif [[ "$subject" =~ ^style(\(.+\))?: ]]; then
              echo "$hash|$subject|$author|$date" >> temp/style.txt
            elif [[ "$subject" =~ ^refactor(\(.+\))?: ]]; then
              echo "$hash|$subject|$author|$date" >> temp/refactor.txt
            elif [[ "$subject" =~ ^test(\(.+\))?: ]]; then
              echo "$hash|$subject|$author|$date" >> temp/tests.txt
            elif [[ "$subject" =~ ^chore(\(.+\))?: ]]; then
              echo "$hash|$subject|$author|$date" >> temp/chore.txt
            elif [[ "$subject" =~ ^ci(\(.+\))?: ]]; then
              echo "$hash|$subject|$author|$date" >> temp/ci.txt
            else
              echo "$hash|$subject|$author|$date" >> temp/other.txt
            fi
          done
          
          # ÁªüËÆ°ÂêÑÁ±ªÊèê‰∫§Êï∞Èáè
          features_count=$([ -f temp/features.txt ] && wc -l < temp/features.txt || echo 0)
          fixes_count=$([ -f temp/fixes.txt ] && wc -l < temp/fixes.txt || echo 0)
          total_commits=$(echo "$commits" | wc -l)
          
          echo "features_count=$features_count" >> $GITHUB_OUTPUT
          echo "fixes_count=$fixes_count" >> $GITHUB_OUTPUT
          echo "total_commits=$total_commits" >> $GITHUB_OUTPUT

      - name: ÁîüÊàêChangelogÂÜÖÂÆπ
        run: |
          # ÂàõÂª∫Êñ∞ÁöÑCHANGELOG.md
          cat > CHANGELOG.md << 'EOF'
          # üìã Êõ¥Êñ∞Êó•Âøó

          Êú¨ÊñáÊ°£ËÆ∞ÂΩï‰∫ÜÈ°πÁõÆÁöÑÊâÄÊúâÈáçË¶ÅÂèòÊõ¥„ÄÇ

          Ê†ºÂºèÈÅµÂæ™ [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)Ôºå
          ÁâàÊú¨ÊéßÂà∂ÈÅµÂæ™ [ËØ≠‰πâÂåñÁâàÊú¨](https://semver.org/lang/zh-CN/)„ÄÇ

          ## [Êú™ÂèëÂ∏É] - TBD

          ### ÂæÖÊ∑ªÂä†
          - Êñ∞ÂäüËÉΩÈ¢ÑÂëä...

          ---
          EOF
          
          # Ëé∑ÂèñÂΩìÂâçÁâàÊú¨Âè∑ÂíåÊó•Êúü
          current_version=${{ steps.version-info.outputs.current_version }}
          release_date=$(date +%Y-%m-%d)
          
          # Ê∑ªÂä†ÂΩìÂâçÁâàÊú¨ÁöÑÂèòÊõ¥
          cat >> CHANGELOG.md << EOF
          ## [${current_version}] - ${release_date}

          ### üìä ÁâàÊú¨ÁªüËÆ°
          - üÜï Êñ∞ÂäüËÉΩ: ${{ steps.categorize-commits.outputs.features_count }} È°π
          - üêõ ÈóÆÈ¢ò‰øÆÂ§ç: ${{ steps.categorize-commits.outputs.fixes_count }} È°π
          - üìù ÊÄªÊèê‰∫§Êï∞: ${{ steps.categorize-commits.outputs.total_commits }} Ê¨°

          EOF
          
          # Ê∑ªÂä†ÂêÑÁ±ªÂèòÊõ¥
          if [ -f temp/features.txt ]; then
            echo "### üÜï Êñ∞ÂäüËÉΩ" >> CHANGELOG.md
            while IFS='|' read -r hash subject author date; do
              clean_subject=$(echo "$subject" | sed 's/^feat[^:]*: //')
              echo "- $clean_subject ([${hash}](https://github.com/${{ github.repository }}/commit/${hash})) - @$author" >> CHANGELOG.md
            done < temp/features.txt
            echo "" >> CHANGELOG.md
          fi
          
          if [ -f temp/fixes.txt ]; then
            echo "### üêõ ÈóÆÈ¢ò‰øÆÂ§ç" >> CHANGELOG.md
            while IFS='|' read -r hash subject author date; do
              clean_subject=$(echo "$subject" | sed 's/^fix[^:]*: //')
              echo "- $clean_subject ([${hash}](https://github.com/${{ github.repository }}/commit/${hash})) - @$author" >> CHANGELOG.md
            done < temp/fixes.txt
            echo "" >> CHANGELOG.md
          fi
          
          if [ -f temp/performance.txt ]; then
            echo "### ‚ö° ÊÄßËÉΩ‰ºòÂåñ" >> CHANGELOG.md
            while IFS='|' read -r hash subject author date; do
              clean_subject=$(echo "$subject" | sed 's/^perf[^:]*: //')
              echo "- $clean_subject ([${hash}](https://github.com/${{ github.repository }}/commit/${hash})) - @$author" >> CHANGELOG.md
            done < temp/performance.txt
            echo "" >> CHANGELOG.md
          fi
          
          if [ -f temp/refactor.txt ]; then
            echo "### üî® ‰ª£Á†ÅÈáçÊûÑ" >> CHANGELOG.md
            while IFS='|' read -r hash subject author date; do
              clean_subject=$(echo "$subject" | sed 's/^refactor[^:]*: //')
              echo "- $clean_subject ([${hash}](https://github.com/${{ github.repository }}/commit/${hash})) - @$author" >> CHANGELOG.md
            done < temp/refactor.txt
            echo "" >> CHANGELOG.md
          fi
          
          if [ -f temp/docs.txt ]; then
            echo "### üìö ÊñáÊ°£Êõ¥Êñ∞" >> CHANGELOG.md
            while IFS='|' read -r hash subject author date; do
              clean_subject=$(echo "$subject" | sed 's/^docs[^:]*: //')
              echo "- $clean_subject ([${hash}](https://github.com/${{ github.repository }}/commit/${hash})) - @$author" >> CHANGELOG.md
            done < temp/docs.txt
            echo "" >> CHANGELOG.md
          fi
          
          if [ -f temp/tests.txt ]; then
            echo "### üß™ ÊµãËØïÊîπËøõ" >> CHANGELOG.md
            while IFS='|' read -r hash subject author date; do
              clean_subject=$(echo "$subject" | sed 's/^test[^:]*: //')
              echo "- $clean_subject ([${hash}](https://github.com/${{ github.repository }}/commit/${hash})) - @$author" >> CHANGELOG.md
            done < temp/tests.txt
            echo "" >> CHANGELOG.md
          fi
          
          if [ -f temp/ci.txt ]; then
            echo "### üîß CI/CDÊîπËøõ" >> CHANGELOG.md
            while IFS='|' read -r hash subject author date; do
              clean_subject=$(echo "$subject" | sed 's/^ci[^:]*: //')
              echo "- $clean_subject ([${hash}](https://github.com/${{ github.repository }}/commit/${hash})) - @$author" >> CHANGELOG.md
            done < temp/ci.txt
            echo "" >> CHANGELOG.md
          fi
          
          if [ -f temp/chore.txt ]; then
            echo "### üõ†Ô∏è ÂÖ∂‰ªñÊîπËøõ" >> CHANGELOG.md
            while IFS='|' read -r hash subject author date; do
              clean_subject=$(echo "$subject" | sed 's/^chore[^:]*: //')
              echo "- $clean_subject ([${hash}](https://github.com/${{ github.repository }}/commit/${hash})) - @$author" >> CHANGELOG.md
            done < temp/chore.txt
            echo "" >> CHANGELOG.md
          fi
          
          if [ -f temp/other.txt ]; then
            echo "### üìã ÂÖ∂‰ªñÂèòÊõ¥" >> CHANGELOG.md
            while IFS='|' read -r hash subject author date; do
              echo "- $subject ([${hash}](https://github.com/${{ github.repository }}/commit/${hash})) - @$author" >> CHANGELOG.md
            done < temp/other.txt
            echo "" >> CHANGELOG.md
          fi
          
          # Ê∑ªÂä†ÊØîËæÉÈìæÊé•
          previous_tag=${{ steps.version-info.outputs.previous_tag }}
          if [[ -n "$previous_tag" ]]; then
            echo "**ÂÆåÊï¥ÂèòÊõ¥Êó•Âøó**: [${previous_tag}...v${current_version}](https://github.com/${{ github.repository }}/compare/${previous_tag}...v${current_version})" >> CHANGELOG.md
          else
            echo "**ÂÆåÊï¥ÂèòÊõ¥Êó•Âøó**: [v${current_version}](https://github.com/${{ github.repository }}/commits/v${current_version})" >> CHANGELOG.md
          fi
          
          echo "" >> CHANGELOG.md
          echo "---" >> CHANGELOG.md
          echo "" >> CHANGELOG.md

      - name: ÈôÑÂä†ÂéÜÂè≤Changelog (Â¶ÇÊûúÂ≠òÂú®)
        run: |
          # Â¶ÇÊûúÂ∑≤ÊúâCHANGELOG.mdÔºåÂ∞ÜÂéÜÂè≤ÂÜÖÂÆπËøΩÂä†
          if [ -f CHANGELOG_backup.md ]; then
            # Ë∑≥ËøáÊóßÊñá‰ª∂ÁöÑÂ§¥ÈÉ®‰ø°ÊÅØÔºåÂè™‰øùÁïôÁâàÊú¨ËÆ∞ÂΩï
            sed -n '/^## \[/,$p' CHANGELOG_backup.md >> CHANGELOG.md
          fi

      - name: Êõ¥Êñ∞READMEÂæΩÁ´†
        if: inputs.update-readme == true || inputs.update-readme == ''
        run: |
          if [ -f README.md ]; then
            current_version=${{ steps.version-info.outputs.current_version }}
            
            # Êõ¥Êñ∞ÁâàÊú¨ÂæΩÁ´†
            sed -i.bak "s|version-[^)]*|version-${current_version}|g" README.md
            
            # Êõ¥Êñ∞npmÂæΩÁ´†
            sed -i.bak "s|npm/v/fe-scaffold-mcp-server/[^)]*|npm/v/fe-scaffold-mcp-server/${current_version}|g" README.md
            
            # Ê∏ÖÁêÜÂ§á‰ªΩÊñá‰ª∂
            rm -f README.md.bak
            
            echo "‚úÖ READMEÂæΩÁ´†Â∑≤Êõ¥Êñ∞"
          fi

      - name: ÁîüÊàêÂèëÂ∏ÉÊëòË¶Å
        run: |
          current_version=${{ steps.version-info.outputs.current_version }}
          
          cat > release-summary.md << EOF
          # üéâ ÁâàÊú¨ ${current_version} ÂèëÂ∏ÉÊëòË¶Å

          ## üìà ÁªüËÆ°‰ø°ÊÅØ
          - **ÂèëÂ∏ÉÊó•Êúü**: $(date +%Y-%m-%d)
          - **Êñ∞ÂäüËÉΩ**: ${{ steps.categorize-commits.outputs.features_count }} È°π
          - **ÈóÆÈ¢ò‰øÆÂ§ç**: ${{ steps.categorize-commits.outputs.fixes_count }} È°π
          - **ÊÄªÊèê‰∫§Êï∞**: ${{ steps.categorize-commits.outputs.total_commits }} Ê¨°

          ## üîó Áõ∏ÂÖ≥ÈìæÊé•
          - [üì¶ NPMÂåÖ](https://www.npmjs.com/package/fe-scaffold-mcp-server)
          - [üìã ÂÆåÊï¥Changelog](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
          - [üè∑Ô∏è GitHub Release](https://github.com/${{ github.repository }}/releases/tag/v${current_version})

          ## üì• ÂÆâË£ÖÊñπÂºè
          \`\`\`bash
          npm install fe-scaffold-mcp-server@${current_version}
          \`\`\`

          ---
          *Ê≠§ÊëòË¶ÅÁî±GitHub ActionsËá™Âä®ÁîüÊàê*
          EOF

      - name: ÈÖçÁΩÆGit
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"

      - name: Êèê‰∫§ChangelogÊõ¥Êñ∞
        run: |
          git add CHANGELOG.md
          if [ -f README.md ]; then
            git add README.md
          fi
          
          # Ê£ÄÊü•ÊòØÂê¶ÊúâÂèòÊõ¥ÈúÄË¶ÅÊèê‰∫§
          if git diff --staged --quiet; then
            echo "üìù ChangelogÊó†ÂèòÊõ¥ÔºåË∑≥ËøáÊèê‰∫§"
          else
            git commit -m "docs: Êõ¥Êñ∞CHANGELOG.mdÂíåREADMEÂæΩÁ´† [skip ci]"
            git push origin HEAD
            echo "‚úÖ ChangelogÂ∑≤Êõ¥Êñ∞Âπ∂Êé®ÈÄÅ"
          fi

      - name: ‰∏ä‰º†ÁîüÊàêÁöÑÊñá‰ª∂
        uses: actions/upload-artifact@v4
        with:
          name: changelog-artifacts
          path: |
            CHANGELOG.md
            release-summary.md
            temp/

      - name: Ê∏ÖÁêÜ‰∏¥Êó∂Êñá‰ª∂
        run: |
          rm -rf temp/
          rm -f CHANGELOG_backup.md

      - name: ËæìÂá∫ÊÄªÁªì
        run: |
          echo "üéâ ChangelogÁîüÊàêÂÆåÊàêÔºÅ"
          echo "üìä ÁªüËÆ°‰ø°ÊÅØ:"
          echo "  - Êñ∞ÂäüËÉΩ: ${{ steps.categorize-commits.outputs.features_count }} È°π"
          echo "  - ÈóÆÈ¢ò‰øÆÂ§ç: ${{ steps.categorize-commits.outputs.fixes_count }} È°π"
          echo "  - ÊÄªÊèê‰∫§Êï∞: ${{ steps.categorize-commits.outputs.total_commits }} Ê¨°"
          echo "üîó Êü•ÁúãÂÆåÊï¥Changelog: https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md"